{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showSection('search')">
                            <i class="fas fa-search"></i> Search Donors
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('users')">
                            <i class="fas fa-users"></i> View Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('notifications')">
                            <i class="fas fa-bell"></i> Notifications
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('pending_admins')">
                            <i class="fas fa-user-clock"></i> Pending Admins
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('notices')">
                            <i class="fas fa-bullhorn"></i> Notice Cards
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/ata">
                            <i class="fas fa-plug"></i> ATA CONNECT
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/incoming_requests_page">
                            <i class="fas fa-inbox"></i> Incoming Requests
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/outgoing_requests_page">
                            <i class="fas fa-paper-plane"></i> Outgoing Requests
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/inventory">
                            <i class="fas fa-boxes"></i> Blood Inventory
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/blood_store">
                            <i class="fas fa-warehouse"></i> Blood Store
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <!-- Search Section -->
            <div id="search-section" class="section">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Search Blood Donors</h1>
                </div>
                
                <!-- Search Form -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="blood_group" class="form-label">Blood Group</label>
                                        <select class="form-select" id="blood_group" name="blood_group">
                                            <option value="">All Blood Groups</option>
                                            <option value="A+">A+</option>
                                            <option value="A-">A-</option>
                                            <option value="B+">B+</option>
                                            <option value="B-">B-</option>
                                            <option value="AB+">AB+</option>
                                            <option value="AB-">AB-</option>
                                            <option value="O+">O+</option>
                                            <option value="O-">O-</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="distance" class="form-label">Maximum Distance (km)</label>
                                        <input type="number" class="form-control" id="distance" name="distance" value="5" min="1" max="50">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-search"></i> Search Donors
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Add this section after the existing search form -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Send SOS Alert</h5>
                    </div>
                    <div class="card-body">
                        <form id="sosAlertForm">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="blood_group">Blood Group Needed</label>
                                        <select class="form-control" id="blood_group" name="blood_group" required>
                                            <option value="">Select Blood Group</option>
                                            <option value="O+">O+</option>
                                            <option value="O-">O-</option>
                                            <option value="A+">A+</option>
                                            <option value="A-">A-</option>
                                            <option value="B+">B+</option>
                                            <option value="B-">B-</option>
                                            <option value="AB+">AB+</option>
                                            <option value="AB-">AB-</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="distance">Maximum Distance (km)</label>
                                        <input type="number" class="form-control" id="distance" name="distance" value="5" min="1" max="50" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-danger">
                                                <i class="fas fa-exclamation-triangle"></i> Send SOS Alert
                                            </button>
                                            <button type="button" class="btn btn-warning" onclick="sendVoiceCall()">
                                                <i class="fas fa-phone"></i> Send Voice Call
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Add this after the search form section -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">Hospital Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Hospital Name</h6>
                                <p>{{ admin.hospital_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Hospital ID</h6>
                                <p>{{ admin.hospital_id }}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Address</h6>
                                <p>{{ admin.address }}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Phone Number</h6>
                                <p>
                                    {% if admin.phone %}
                                        {{ admin.phone }}
                                        <button class="btn btn-sm btn-outline-danger ms-2" data-bs-toggle="modal" data-bs-target="#editPhoneModal">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    {% else %}
                                        <span class="text-danger">No phone number set</span>
                                        <button class="btn btn-sm btn-outline-danger ms-2" data-bs-toggle="modal" data-bs-target="#editPhoneModal">
                                            <i class="fas fa-plus"></i> Add Phone
                                        </button>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="searchResults" class="row">
                    {% if donors %}
                        <div class="col-12 mb-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-0">
                                                <i class="fas fa-users"></i> Found {{ donors|length }} eligible donors within 5km
                                            </h5>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary" id="sendAlertBtn">
                                                <i class="fas fa-bell"></i> Send Alert to Selected Donors
                                            </button>
                                            <button class="btn btn-success" id="callSelectedBtn">
                                                <i class="fas fa-phone"></i> Call Selected Donors
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% for donor in donors %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="d-flex align-items-center mb-2">
                                                <h5 class="card-title mb-0 me-2">{{ donor.name }}</h5>
                                                <span class="badge bg-danger">{{ donor.blood_group }}</span>
                                            </div>
                                            <div class="mb-3">
                                                <span class="badge bg-success">
                                                    <i class="fas fa-star"></i> Match Score: {{ donor.score }}%
                                                </span>
                                            </div>
                                            <div class="card-text">
                                                <p class="mb-2">
                                                    <i class="fas fa-map-marker-alt text-danger"></i>
                                                    {{ donor.address }}
                                                </p>
                                                <p class="mb-2 d-flex align-items-center gap-2">
                                                    <span>
                                                        <i class="fas fa-phone text-primary"></i>
                                                        {{ donor.phone }}
                                                    </span>
                                                    <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="callDonor('{{ donor.phone }}','{{ donor.name }}','{{ donor.blood_group }}')">
                                                        <i class="fas fa-phone-alt"></i> Call
                                                    </button>
                                                </p>
                                                <p class="mb-2">
                                                    <i class="fas fa-envelope text-info"></i>
                                                    {{ donor.email }}
                                                </p>
                                                <p class="mb-2">
                                                    <i class="fas fa-road text-warning"></i>
                                                    {{ donor.distance }} km away
                                                </p>
                                                {% if donor.last_notified %}
                                                <p class="mb-0 text-muted">
                                                    <i class="fas fa-clock"></i>
                                                    Last notified: {{ donor.last_notified }}
                                                </p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input donor-checkbox" type="checkbox" 
                                                   value="{{ donor.id }}" data-phone="{{ donor.phone }}" id="donor{{ donor.id }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> No eligible donors found within 5km.
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" class="section" style="display: none;">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">View Users</h1>
                </div>
                
                <!-- All Users Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">All Users</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Blood Group</th>
                                        <th>Phone</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Users will be loaded here via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Section -->
            <div id="notifications-section" class="section" style="display: none;">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Notifications</h1>
                </div>
                <div id="notificationsList">
                    <!-- Notifications will be loaded here -->
                </div>
            </div>

            <!-- Pending Admins Section -->
            <div id="pending_admins-section" class="section" style="display: none;">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Pending Admin Accounts</h1>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Hospital Name</th>
                                <th>Hospital ID</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Address</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingAdminsList">
                            <!-- Pending admins will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Notice Cards Section -->
            <div id="notices-section" class="section" style="display: none;">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Notice Cards</h1>
                    <a href="/admin/notice" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create New Notice
                    </a>
                </div>
                <div id="noticesList" class="row">
                    <!-- Notices will be loaded here -->
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Send Alert Modal -->
<div class="modal fade" id="sendAlertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Alert to Selected Donors</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="alertMessage" class="form-label">Alert Message</label>
                    <textarea class="form-control" id="alertMessage" rows="4" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendAlert()">Send Alert</button>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Phone Modal -->
<div class="modal fade" id="editPhoneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Hospital Phone Number</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="phoneForm">
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phone" name="phone" 
                               value="{{ admin.phone }}" required
                               pattern="[0-9]{10}" title="Please enter a valid 10-digit phone number">
                        <div class="form-text">Enter a valid 10-digit phone number</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="updatePhone()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Donor Details Modal -->
<div class="modal fade" id="donorDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Donor Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="donorDetailsContent">
                <!-- Donor details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    <input type="hidden" id="recipientPhone" name="recipientPhone">
                    <input type="hidden" id="recipientName" name="recipientName">
                    <div class="mb-3">
                        <label for="messageText" class="form-label">Message</label>
                        <textarea class="form-control" id="messageText" name="messageText" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useWhatsapp" name="useWhatsapp">
                            <label class="form-check-label" for="useWhatsapp">
                                Send via WhatsApp
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendMessageSubmit()">Send Message</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Add these styles to your existing CSS */
.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
}

input:checked + .slider {
    background-color: #2196F3;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.slider.round {
    border-radius: 34px;
}

.slider.round:before {
    border-radius: 50%;
}

.label {
    margin-left: 70px;
    font-size: 14px;
    color: #666;
}
</style>

{% endblock %}

{% block scripts %}
<script>
let selectedDonors = new Set();

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show selected section
    document.getElementById(sectionId + '-section').style.display = 'block';
    
    // Update active nav link
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    event.target.classList.add('active');
}

// Handle search form submission
document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Show loading state
    document.getElementById('searchResults').innerHTML = `
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin"></i> Searching for donors...
            </div>
        </div>
    `;
    
    fetch('/admin/search_donors', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySearchResults(data.donors);
        } else {
            document.getElementById('searchResults').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> ${data.error}
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('searchResults').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> Error searching for donors
                </div>
            </div>
        `;
    });
});

function displaySearchResults(donors) {
    const searchResults = document.getElementById('searchResults');
    searchResults.innerHTML = '';
    
    if (donors.length === 0) {
        searchResults.innerHTML = `
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No matching donors found within the specified criteria.
                </div>
            </div>
        `;
        return;
    }

    // Add summary and alert button
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'col-12 mb-4';
    summaryDiv.innerHTML = `
        <div class="card bg-light">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-users"></i> Found ${donors.length} matching donors
                        </h5>
                    </div>
                    <button class="btn btn-primary" id="sendAlertBtn">
                        <i class="fas fa-bell"></i> Send Alert to Selected Donors
                    </button>
                </div>
            </div>
        </div>
    `;
    searchResults.appendChild(summaryDiv);

    // Display donor cards
    donors.forEach(donor => {
        const card = document.createElement('div');
        card.className = 'col-md-6 mb-4';
        card.innerHTML = `
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="card-title mb-0 me-2">${donor.name}</h5>
                                <span class="badge bg-danger">${donor.blood_group}</span>
                            </div>
                            <div class="mb-3">
                                <span class="badge bg-success">
                                    <i class="fas fa-star"></i> Match Score: ${donor.score}%
                                </span>
                            </div>
                            <div class="card-text">
                                <p class="mb-2">
                                    <i class="fas fa-map-marker-alt text-danger"></i>
                                    ${donor.address}
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-phone text-primary"></i>
                                    ${donor.phone}
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-envelope text-info"></i>
                                    ${donor.email}
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-road text-warning"></i>
                                    ${donor.distance} km away
                                </p>
                                ${donor.last_notified ? `
                                    <p class="mb-0 text-muted">
                                        <i class="fas fa-clock"></i>
                                        Last notified: ${donor.last_notified}
                                    </p>
                                ` : ''}
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input donor-checkbox" type="checkbox"
                                   value="${donor.id}" data-phone="${donor.phone}" id="donor${donor.id}">
                        </div>
                    </div>
                </div>
            </div>
        `;
        searchResults.appendChild(card);
    });

    // Handle donor selection
    document.querySelectorAll('.donor-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                selectedDonors.add(this.value);
            } else {
                selectedDonors.delete(this.value);
            }
            updateSelectedCount();
        });
    });

    // Handle alert button click
    document.getElementById('sendAlertBtn').addEventListener('click', function() {
        if (selectedDonors.size === 0) {
            alert('Please select at least one donor');
            return;
        }
        $('#sendAlertModal').modal('show');
    });

    // Handle call selected button
    const callSelectedBtn = document.getElementById('callSelectedBtn');
    if (callSelectedBtn) {
        callSelectedBtn.addEventListener('click', function() {
            if (selectedDonors.size === 0) {
                alert('Please select at least one donor');
                return;
            }

            // Collect phone numbers from selected checkboxes
            const phones = Array.from(document.querySelectorAll('.donor-checkbox:checked'))
                .map(cb => cb.getAttribute('data-phone'))
                .filter(Boolean);

            if (phones.length === 0) {
                alert('No phone numbers found for selected donors');
                return;
            }

            // Confirm bulk call
            if (!confirm(`Place voice calls to ${phones.length} selected donor(s)?`)) {
                return;
            }

            // Normalize numbers (add +91 for 10-digit)
            const normalized = phones.map(p => {
                let x = (p || '').toString().trim();
                if (/^\d{10}$/.test(x)) x = '+91' + x;
                return x;
            });

            const bloodGroup = document.getElementById('blood_group').value || 'the required';
            const distance = document.getElementById('distance').value || 'your area';
            const message = `Hello, this is an urgent blood donation request. We need ${bloodGroup} blood group donors within ${distance} kilometers. Please contact the hospital. Thank you.`;

            fetch('/admin/voice_call_bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone_numbers: normalized, message })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const ok = data.results?.filter(r => r.success).length || 0;
                    const fail = data.results?.length ? (data.results.length - ok) : 0;
                    alert(`Calls initiated. Success: ${ok}, Failed: ${fail}`);
                } else {
                    alert('Error placing bulk calls: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('Network error placing bulk calls');
            });
        });
    }
}

function updateSelectedCount() {
    const alertBtn = document.getElementById('sendAlertBtn');
    const callBtn = document.getElementById('callSelectedBtn');
    if (alertBtn) {
        alertBtn.innerHTML = `
            <i class="fas fa-bell"></i> Send Alert to ${selectedDonors.size} Selected Donors
        `;
    }
    if (callBtn) {
        callBtn.innerHTML = `
            <i class="fas fa-phone"></i> Call ${selectedDonors.size} Selected
        `;
        callBtn.disabled = selectedDonors.size === 0;
    }
}

function sendAlert() {
    const message = document.getElementById('alertMessage').value;
    if (!message) {
        alert('Please enter an alert message');
        return;
    }

    fetch('/admin/send_alert', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            donor_ids: Array.from(selectedDonors),
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            $('#sendAlertModal').modal('hide');
            document.getElementById('alertMessage').value = '';
            selectedDonors.clear();
            updateSelectedCount();
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        alert('Error sending alert');
    });
}

function viewUser(userId) {
    fetch(`/admin/user/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                document.getElementById('userDetailsContent').innerHTML = `
                    <div class="mb-3">
                        <h6>Name</h6>
                        <p>${user.name}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Blood Group</h6>
                        <p>${user.blood_group}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Email</h6>
                        <p>${user.email}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Phone</h6>
                        <p>${user.phone}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Address</h6>
                        <p>${user.location.address}</p>
                    </div>
                    ${data.last_notification ? `
                        <div class="mb-3">
                            <h6>Last Notification</h6>
                            <p>${data.last_notification.message}</p>
                            <small class="text-muted">${data.last_notification.created_at}</small>
                        </div>
                    ` : ''}
                `;
                $('#userDetailsModal').modal('show');
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            alert('Error loading user details');
        });
}

function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) {
        return;
    }

    fetch(`/admin/user/${userId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        alert('Error deleting user');
    });
}

// Load notifications
function loadNotifications() {
    fetch('/admin/notifications')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const notificationsList = document.getElementById('notificationsList');
                if (data.notifications.length === 0) {
                    notificationsList.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No notifications found
                        </div>
                    `;
                    return;
                }

                notificationsList.innerHTML = data.notifications.map(notification => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">${notification.message}</h6>
                            <p class="card-text text-muted">
                                <small>${notification.created_at}</small>
                            </p>
                        </div>
                    </div>
                `).join('');
            }
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
        });
}

// Load notifications when the section is shown
document.querySelector('a[onclick="showSection(\'notifications\')"]').addEventListener('click', loadNotifications);

// Voice Call Function
function sendVoiceCall() {
    const bloodGroup = document.getElementById('blood_group').value;
    const distance = document.getElementById('distance').value;
    
    if (!bloodGroup) { alert('Please select a blood group'); return; }
    if (!distance || distance < 1 || distance > 50) { alert('Please enter a valid distance between 1 and 50 km'); return; }

    // Determine which phones to call: selected donors, otherwise all in results
    let phones = Array.from(document.querySelectorAll('.donor-checkbox:checked'))
        .map(cb => cb.getAttribute('data-phone'))
        .filter(Boolean);

    if (phones.length === 0) {
        phones = Array.from(document.querySelectorAll('.donor-checkbox'))
            .map(cb => cb.getAttribute('data-phone'))
            .filter(Boolean);
    }

    if (phones.length === 0) { alert('No donor phone numbers available'); return; }

    // Normalize numbers (add +91 for 10-digit plain numbers)
    const normalized = phones.map(p => {
        let x = (p || '').toString().trim();
        if (/^\d{10}$/.test(x)) x = '+91' + x;
        return x;
    });

    const message = `Hello, this is an urgent blood donation request. We need ${bloodGroup} blood group donors within ${distance} kilometers. Please contact the hospital. Thank you.`;

    // If single number, use single-call endpoint; else bulk
    if (normalized.length === 1) {
        fetch('/admin/voice_call', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to_number: normalized[0], message })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) alert(`Calling ${normalized[0]}. Call SID: ${data.call_sid}`);
            else alert('Error making voice call: ' + (data.error || 'Unknown error'));
        })
        .catch(() => alert('Network error making voice call'));
    } else {
        fetch('/admin/voice_call_bulk', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone_numbers: normalized, message })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const ok = data.results?.filter(r => r.success).length || 0;
                const fail = data.results?.length ? (data.results.length - ok) : 0;
                alert(`Calls initiated. Success: ${ok}, Failed: ${fail}`);
            } else {
                alert('Error placing calls: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(() => alert('Network error placing calls'));
    }
}

// Direct donor call without prompts
function callDonor(rawPhone, donorName, bloodGroup) {
    // Normalize: if 10 digits, assume India and add +91
    let phone = (rawPhone || '').toString().trim();
    if (!phone) {
        alert('No phone number available for this donor');
        return;
    }
    if (/^\d{10}$/.test(phone)) {
        phone = '+91' + phone;
    }
    if (!/^\+\d{7,15}$/.test(phone)) {
        alert('Invalid phone number format: ' + phone);
        return;
    }

    const bg = bloodGroup || (document.getElementById('blood_group').value || 'the required');
    const distance = document.getElementById('distance').value || 'your area';
    const message = `Hello ${donorName || ''}, this is an urgent blood donation request. We need ${bg} donors within ${distance} kilometers. If you can help, please press 1. To decline, press 2.`;

    fetch('/admin/voice_call', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to_number: phone, message, donor_name: donorName || '', blood_group: bg })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(`Calling ${phone}. Call SID: ${data.call_sid}`);
        } else {
            alert('Error making voice call: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('Network error making voice call');
    });
}

// Add SOS Alert Form Handler
document.getElementById('sosAlertForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const bloodGroup = document.getElementById('blood_group').value;
    const distance = document.getElementById('distance').value;
    
    if (!bloodGroup) {
        alert('Please select a blood group');
        return;
    }
    
    if (!distance || distance < 1 || distance > 50) {
        alert('Please enter a valid distance between 1 and 50 km');
        return;
    }
    
    // Show confirmation dialog
    if (!confirm(`Are you sure you want to send an SOS alert to all ${bloodGroup} donors within ${distance}km?`)) {
        return;
    }
    
    // Send the alert
    fetch('/admin/send_alert', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            blood_group: bloodGroup,
            distance: parseFloat(distance)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Reset the form
            this.reset();
        } else {
            alert(data.error || 'Error sending SOS alert');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending SOS alert');
    });
});

function updatePhone() {
    const phone = document.getElementById('phone').value;
    
    if (!phone || !phone.match(/^[0-9]{10}$/)) {
        alert('Please enter a valid 10-digit phone number');
        return;
    }
    
    fetch('/admin/update_phone', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ phone: phone })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Phone number updated successfully');
            location.reload();
        } else {
            alert(data.error || 'Error updating phone number');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating phone number');
    });
}

// Add this function to load pending admins
function loadPendingAdmins() {
    fetch('/admin/pending_admins')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const pendingAdminsList = document.getElementById('pendingAdminsList');
                if (data.admins.length === 0) {
                    pendingAdminsList.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle"></i> No pending admin accounts
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                pendingAdminsList.innerHTML = data.admins.map(admin => `
                    <tr>
                        <td>${admin.hospital_name}</td>
                        <td>${admin.hospital_id}</td>
                        <td>${admin.email}</td>
                        <td>${admin.phone}</td>
                        <td>${admin.address}</td>
                        <td>${new Date(admin.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="activateAdmin('${admin._id}')">
                                <i class="fas fa-check"></i> Activate
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        })
        .catch(error => {
            console.error('Error loading pending admins:', error);
        });
}

// Add this function to handle admin activation
function activateAdmin(adminId) {
    if (!confirm('Are you sure you want to activate this admin account?')) {
        return;
    }

    fetch(`/admin/activate/${adminId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Admin account activated successfully');
            loadPendingAdmins(); // Reload the list
        } else {
            alert(data.error || 'Error activating account');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error activating account');
    });
}

// Load pending admins when the section is shown
document.querySelector('a[onclick="showSection(\'pending_admins\')"]').addEventListener('click', loadPendingAdmins);

document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const bloodGroup = document.getElementById('blood_group').value;
    const distance = document.getElementById('distance').value;
    const useWhatsApp = document.getElementById('useWhatsApp').checked;
    
    try {
        const response = await fetch('/admin/send_alert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                blood_group: bloodGroup,
                distance: distance,
                use_whatsapp: useWhatsApp
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            if (data.errors && data.errors.length > 0) {
                console.error('Errors:', data.errors);
            }
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while sending alerts');
    }
});

// Load notices when the section is shown
document.querySelector('a[onclick="showSection(\'notices\')"]').addEventListener('click', loadNotices);

// Add this function to load notices
function loadNotices() {
    fetch('/admin/notices')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const noticesList = document.getElementById('noticesList');
                if (data.notices.length === 0) {
                    noticesList.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> No notice cards found. Click "Create New Notice" to add one.
                            </div>
                        </div>
                    `;
                    return;
                }

                noticesList.innerHTML = data.notices.map(notice => `
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="d-flex align-items-center mb-2">
                                            <h5 class="card-title mb-0 me-2">${notice.title}</h5>
                                            <span class="badge ${notice.organization_type === 'NGO' ? 'bg-success' : 'bg-danger'}">
                                                ${notice.organization_type}
                                            </span>
                                        </div>
                                        <h6 class="text-muted">${notice.organization_name}</h6>
                                        <p class="card-text mt-3">${notice.description}</p>
                                        <div class="mt-3">
                                            <p class="mb-2">
                                                <i class="fas fa-user text-primary"></i>
                                                ${notice.contact_person}
                                            </p>
                                            <p class="mb-2">
                                                <i class="fas fa-phone text-success"></i>
                                                ${notice.contact_number}
                                            </p>
                                            <p class="mb-2">
                                                <i class="fas fa-envelope text-info"></i>
                                                ${notice.email}
                                            </p>
                                            <p class="mb-2">
                                                <i class="fas fa-map-marker-alt text-danger"></i>
                                                ${notice.address}
                                            </p>
                                            ${notice.event_date ? `
                                                <p class="mb-2">
                                                    <i class="fas fa-calendar text-warning"></i>
                                                    Event Date: ${new Date(notice.event_date).toLocaleDateString()}
                                                </p>
                                            ` : ''}
                                        </div>
                                        ${notice.requirements && notice.requirements.length > 0 ? `
                                            <div class="mt-3">
                                                <h6>Requirements:</h6>
                                                <ul class="list-unstyled">
                                                    ${notice.requirements.map(req => `
                                                        <li><i class="fas fa-check text-success"></i> ${req}</li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        ${notice.blood_groups_needed && notice.blood_groups_needed.length > 0 ? `
                                            <div class="mt-3">
                                                <h6>Blood Groups Needed:</h6>
                                                <div class="d-flex flex-wrap gap-2">
                                                    ${notice.blood_groups_needed.map(group => `
                                                        <span class="badge bg-danger">${group}</span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        <p class="card-text mt-3">
                                            <small class="text-muted">
                                                Created: ${new Date(notice.created_at).toLocaleString()}<br>
                                                Status: ${notice.status}
                                            </small>
                                        </p>
                                    </div>
                                </div>
                                <div class="mt-3 d-flex justify-content-end gap-2">
                                    <button class="btn btn-sm btn-danger" onclick="deleteNotice('${notice._id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                    <button class="btn btn-sm ${notice.status === 'active' ? 'btn-warning' : 'btn-success'}"
                                            onclick="toggleNoticeStatus('${notice._id}', '${notice.status}')">
                                        <i class="fas ${notice.status === 'active' ? 'fa-pause' : 'fa-play'}"></i>
                                        ${notice.status === 'active' ? 'Deactivate' : 'Activate'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                console.error('Error loading notices:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading notices:', error);
        });
}

// Add this function to delete a notice
function deleteNotice(noticeId) {
    if (!confirm('Are you sure you want to delete this notice?')) {
        return;
    }

    fetch(`/admin/notice/${noticeId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Notice deleted successfully');
            loadNotices();
        } else {
            alert(data.error || 'Error deleting notice');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting notice');
    });
}

// Add this function to toggle notice status
function toggleNoticeStatus(noticeId, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    
    fetch(`/admin/notice/${noticeId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Notice ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully`);
            loadNotices();
        } else {
            alert(data.error || 'Error updating notice status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating notice status');
    });
}

// Function to view donor details
function viewDonorDetails(userId) {
    fetch(`/admin/user/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const donor = data.user;
                const content = document.getElementById('donorDetailsContent');
                
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Personal Information</h6>
                            <p><strong>Name:</strong> ${donor.name}</p>
                            <p><strong>Email:</strong> ${donor.email}</p>
                            <p><strong>Phone:</strong> ${donor.phone || 'N/A'}</p>
                            <p><strong>Blood Group:</strong> <span class="badge bg-danger">${donor.blood_group}</span></p>
                            <p><strong>Address:</strong> ${donor.address || 'N/A'}</p>
                            <p><strong>City:</strong> ${donor.city || 'N/A'}</p>
                            <p><strong>State:</strong> ${donor.state || 'N/A'}</p>
                            <p><strong>Pincode:</strong> ${donor.pincode || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Donation History</h6>
                            <p><strong>Last Donation:</strong> ${donor.last_donation || 'Never'}</p>
                            <p><strong>Total Donations:</strong> ${donor.total_donations || 0}</p>
                            <p><strong>Last Notification:</strong> ${donor.last_notified || 'Never'}</p>
                            <p><strong>Account Created:</strong> ${donor.created_at}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Health Data</h6>
                            <p><strong>Weight:</strong> ${donor.health_data?.weight || 'N/A'} kg</p>
                            <p><strong>Height:</strong> ${donor.health_data?.height || 'N/A'} cm</p>
                            <p><strong>Blood Pressure:</strong> ${donor.health_data?.blood_pressure || 'N/A'}</p>
                            <p><strong>Diabetes:</strong> ${donor.health_data?.diabetes ? 'Yes' : 'No'}</p>
                            <p><strong>Last Updated:</strong> ${donor.health_data?.updated_at || 'Never'}</p>
                        </div>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('donorDetailsModal'));
                modal.show();
            } else {
                alert('Error loading donor details: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading donor details');
        });
}

// Function to open message modal
function sendMessage(phone, name) {
    document.getElementById('recipientPhone').value = phone;
    document.getElementById('recipientName').value = name;
    document.getElementById('messageText').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('messageModal'));
    modal.show();
}

// Function to submit message
function sendMessageSubmit() {
    const phone = document.getElementById('recipientPhone').value;
    const name = document.getElementById('recipientName').value;
    const message = document.getElementById('messageText').value;
    const useWhatsapp = document.getElementById('useWhatsapp').checked;
    
    if (!message) {
        alert('Please enter a message');
        return;
    }
    
    fetch('/admin/send_alert', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            phone_numbers: [phone],
            message: message,
            use_whatsapp: useWhatsapp
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Message sent successfully to ${name}`);
            bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
        } else {
            alert('Error sending message: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending message');
    });
}

// Function to load all users
function loadAllUsers() {
    fetch('/admin/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';
                
                data.users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="badge bg-danger">${user.blood_group}</span></td>
                        <td>${user.phone || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewDonorDetails('${user._id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user._id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                console.error('Error loading users:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// Function to delete user
function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        fetch(`/admin/user/${userId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User deleted successfully');
                loadAllUsers();
            } else {
                alert('Error deleting user: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user');
        });
    }
}

// Load all users when the users section is shown
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for the users section tab
    const usersTab = document.querySelector('a[href="#"][onclick="showSection(\'users\')"]');
    if (usersTab) {
        usersTab.addEventListener('click', function() {
            loadAllUsers();
        });
    }
});
</script>
{% endblock %} 