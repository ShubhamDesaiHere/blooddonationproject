{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/inventory">
                            <i class="fas fa-boxes"></i> Blood Inventory
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/blood_availability">
                            <i class="fas fa-tint"></i> Blood Availability
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <div>
                    <h1 class="h2">Blood Inventory Management</h1>
                    <p class="text-muted mb-0">
                        <i class="fas fa-hospital"></i> Hospital: <strong>{{ admin.hospital_name }}</strong> 
                        (ID: {{ admin.hospital_id }})
                    </p>
                </div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUnitModal">
                    <i class="fas fa-plus"></i> Add Blood Unit
                </button>
            </div>

            <!-- Inventory Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">Total Units</h5>
                            <h2 id="totalUnits">{{ inventory_items|length }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title">Available</h5>
                            <h2 id="availableUnits">{{ inventory_items|selectattr('status', 'equalto', 'available')|list|length }}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <h5 class="card-title">Expiring Soon</h5>
                            <h2 id="expiringSoon">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger">
                        <div class="card-body">
                            <h5 class="card-title">Expired</h5>
                            <h2 id="expiredUnits">0</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="filterBloodType" class="form-label">Filter by Blood Type</label>
                            <select class="form-select" id="filterBloodType">
                                <option value="">All Blood Types</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterStatus" class="form-label">Filter by Status</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">All Status</option>
                                <option value="available">Available</option>
                                <option value="used">Used</option>
                                <option value="expired">Expired</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="searchBloodId" class="form-label">Search by Blood ID</label>
                            <input type="text" class="form-control" id="searchBloodId" placeholder="Enter Blood ID">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Blood Units Inventory</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>Blood ID</th>
                                    <th>Blood Type</th>
                                    <th>Entry Time</th>
                                    <th>Expiry Date</th>
                                    <th>Days Remaining</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                {% for item in inventory_items %}
                                <tr data-blood-type="{{ item.blood_type }}" data-status="{{ item.status }}" data-blood-id="{{ item.blood_id }}">
                                    <td><strong>{{ item.blood_id }}</strong></td>
                                    <td><span class="badge bg-danger">{{ item.blood_type }}</span></td>
                                    <td>
                                        {% if item.entry_time %}
                                            {% if item.entry_time is string %}
                                                {{ item.entry_time }}
                                            {% else %}
                                                {{ item.entry_time.strftime('%Y-%m-%d %H:%M:%S') }}
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.expiry_date %}
                                            {% if item.expiry_date is string %}
                                                {{ item.expiry_date }}
                                            {% else %}
                                                {{ item.expiry_date.strftime('%Y-%m-%d %H:%M:%S') }}
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.days_remaining is defined %}
                                            {% if item.is_expired %}
                                                <span class="badge bg-danger">Expired ({{ item.days_remaining|abs }} days ago)</span>
                                            {% elif item.is_expiring_soon %}
                                                <span class="badge bg-warning">{{ item.days_remaining }} days</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ item.days_remaining }} days</span>
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if item.status == 'available' %}bg-success
                                            {% elif item.status == 'used' %}bg-secondary
                                            {% elif item.status == 'expired' %}bg-danger
                                            {% else %}bg-info{% endif %}">
                                            {{ item.status|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column flex-lg-row gap-2">
                                            <div class="input-group input-group-sm">
                                                <label class="input-group-text" for="statusSelect{{ loop.index }}">Status</label>
                                                <select class="form-select form-select-sm status-select" id="statusSelect{{ loop.index }}" data-blood-id="{{ item.blood_id }}">
                                                    <option value="available" {% if item.status == 'available' %}selected{% endif %}>Available</option>
                                                    <option value="used" {% if item.status == 'used' %}selected{% endif %}>Used</option>
                                                    <option value="expired" {% if item.status == 'expired' %}selected{% endif %}>Expired</option>
                                                </select>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary" onclick="updateStatus('{{ item.blood_id }}')">
                                                    <i class="fas fa-sync-alt"></i> Update
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteUnit('{{ item.blood_id }}')">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="noResults" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle"></i> No blood units found matching the filters.
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Add Blood Unit Modal -->
<div class="modal fade" id="addUnitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Blood Unit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUnitForm">
                    <div class="mb-3">
                        <label for="blood_type" class="form-label">Blood Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="blood_type" name="blood_type" required>
                            <option value="">Select Blood Type</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="blood_id" class="form-label">Blood ID <span class="text-muted">(auto if empty)</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="blood_id" name="blood_id"
                                   placeholder="Leave empty to auto-generate">
                            <button class="btn btn-outline-secondary" type="button" id="generateIdBtn" onclick="generateBloodId()">
                                <i class="fas fa-random"></i> Generate
                            </button>
                        </div>
                        <div class="form-text">Blood ID must be unique per hospital. Leave empty or click Generate to let the system create one.</div>
                    </div>
                    <div class="mb-3">
                        <label for="entry_time" class="form-label">Entry Time</label>
                        <input type="datetime-local" class="form-control" id="entry_time" name="entry_time">
                        <div class="form-text">Leave empty to use current time. Expiry date will be automatically set to 42 days from entry time.</div>
                    </div>
                    <div id="formMessage" class="mt-3"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addBloodUnit()">Add Unit</button>
            </div>
        </div>
    </div>
</div>

<script>
// Calculate summary statistics
function updateSummary() {
    const rows = document.querySelectorAll('#inventoryTableBody tr:not([style*="display: none"])');
    let total = 0;
    let available = 0;
    let expiringSoon = 0;
    let expired = 0;
    
    rows.forEach(row => {
        total++;
        const status = row.getAttribute('data-status');
        const daysRemaining = parseInt(row.querySelector('td:nth-child(5) .badge')?.textContent.match(/\d+/)?.[0] || '0');
        
        if (status === 'available') available++;
        if (daysRemaining >= 0 && daysRemaining <= 7 && status === 'available') expiringSoon++;
        if (row.querySelector('.bg-danger') && row.querySelector('td:nth-child(5) .badge')?.textContent.includes('Expired')) expired++;
    });
    
    document.getElementById('totalUnits').textContent = total;
    document.getElementById('availableUnits').textContent = available;
    document.getElementById('expiringSoon').textContent = expiringSoon;
    document.getElementById('expiredUnits').textContent = expired;
}

// Filter functionality
function filterTable() {
    const bloodType = document.getElementById('filterBloodType').value;
    const status = document.getElementById('filterStatus').value;
    const searchId = document.getElementById('searchBloodId').value.toLowerCase();
    const rows = document.querySelectorAll('#inventoryTableBody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const rowBloodType = row.getAttribute('data-blood-type');
        const rowStatus = row.getAttribute('data-status');
        const rowBloodId = row.getAttribute('data-blood-id').toLowerCase();
        
        let show = true;
        
        if (bloodType && rowBloodType !== bloodType) show = false;
        if (status && rowStatus !== status) show = false;
        if (searchId && !rowBloodId.includes(searchId)) show = false;
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
    updateSummary();
}

document.getElementById('filterBloodType').addEventListener('change', filterTable);
document.getElementById('filterStatus').addEventListener('change', filterTable);
document.getElementById('searchBloodId').addEventListener('input', filterTable);

function clearFilters() {
    document.getElementById('filterBloodType').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('searchBloodId').value = '';
    filterTable();
}

function showToast(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = 1080;
    alertDiv.innerHTML = message;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
}

function generateBloodId() {
    const btn = document.getElementById('generateIdBtn');
    if (btn) {
        btn.classList.add('disabled');
        btn.setAttribute('disabled', 'disabled');
    }
    
    fetch('/admin/inventory/generate_blood_id', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success && result.blood_id) {
            const input = document.getElementById('blood_id');
            input.value = result.blood_id;
            showToast('Blood ID generated', 'success');
        } else {
            showToast(result.error || 'Failed to generate Blood ID', 'danger');
        }
    })
    .catch(error => {
        console.error('Error generating blood ID:', error);
        showToast('An error occurred while generating Blood ID', 'danger');
    })
    .finally(() => {
        if (btn) {
            btn.classList.remove('disabled');
            btn.removeAttribute('disabled');
        }
    });
}

function updateStatus(bloodId) {
    const select = document.querySelector(`.status-select[data-blood-id="${bloodId}"]`);
    if (!select) {
        return;
    }

    fetch('/admin/inventory/update_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            blood_id: bloodId,
            status: select.value
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast(result.message, 'success');
            setTimeout(() => location.reload(), 800);
        } else {
            showToast(result.error || 'Failed to update status', 'danger');
        }
    })
    .catch(error => {
        console.error('Error updating status:', error);
        showToast('An error occurred while updating status', 'danger');
    });
}

// Add blood unit
function addBloodUnit() {
    const form = document.getElementById('addUnitForm');
    const formData = new FormData(form);
    const data = {
        blood_type: formData.get('blood_type'),
        blood_id: formData.get('blood_id'),
        entry_time: formData.get('entry_time')
    };
    
    if (!data.blood_type) {
        showMessage('Please select a blood type', 'danger');
        return;
    }
    
    // Convert local datetime to ISO format
    if (data.entry_time) {
        const localDate = new Date(data.entry_time);
        data.entry_time = localDate.toISOString();
    }
    
    fetch('/admin/inventory/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showMessage(result.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showMessage(result.error || 'Failed to add blood unit', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred while adding the blood unit', 'danger');
    });
}

function showMessage(message, type) {
    const msgDiv = document.getElementById('formMessage');
    msgDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => {
        msgDiv.innerHTML = '';
    }, 5000);
}

// Delete blood unit
function deleteUnit(bloodId) {
    if (!confirm('Are you sure you want to delete this blood unit? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/admin/inventory/delete/${bloodId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert(result.error || 'Failed to delete blood unit');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the blood unit');
    });
}

// Initialize summary on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSummary();
    const addUnitModalEl = document.getElementById('addUnitModal');
    if (addUnitModalEl) {
        addUnitModalEl.addEventListener('shown.bs.modal', function() {
            const input = document.getElementById('blood_id');
            if (input && !input.value) {
                generateBloodId();
            }
        });
    }
});
</script>
{% endblock %}

